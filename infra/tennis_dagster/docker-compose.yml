name: tennis_dagster

services:
  postgres:
    image: postgres:16-alpine
    container_name: tennis_dagster_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-tennis_simulator}
      POSTGRES_USER: ${POSTGRES_USER:-tennis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tennis}
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - tennis_dagster_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 20

  dagster_webserver:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tennis_dagster_webserver
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DAGSTER_HOME: /opt/dagster/dagster_home
      POSTGRES_DB: ${POSTGRES_DB:-tennis_simulator}
      POSTGRES_USER: ${POSTGRES_USER:-tennis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tennis}
      DATABASE_URL: ${DATABASE_URL}
      TA_ELO_MEN_URL: ${TA_ELO_MEN_URL:-}
      TA_ELO_WOMEN_URL: ${TA_ELO_WOMEN_URL:-}
      TA_YELO_MEN_URL: ${TA_YELO_MEN_URL:-}
      TA_YELO_WOMEN_URL: ${TA_YELO_WOMEN_URL:-}
      SCRAPER_USER_AGENT: ${SCRAPER_USER_AGENT:-}
      TA_DRAW_EXAMPLE_URL: ${TA_DRAW_EXAMPLE_URL:-}
    ports:
      - "${DAGSTER_WEB_PORT:-3001}:3000"
    volumes:
      - ./dagster_home:/opt/dagster/dagster_home
      - ./backfills:/opt/dagster/app/backfills:ro
    command: ["dagster-webserver", "-h", "0.0.0.0", "-p", "3000", "-w", "/opt/dagster/dagster_home/workspace.yaml"]

  dagster_daemon:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tennis_dagster_daemon
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DAGSTER_HOME: /opt/dagster/dagster_home
      POSTGRES_DB: ${POSTGRES_DB:-tennis_simulator}
      POSTGRES_USER: ${POSTGRES_USER:-tennis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tennis}
      DATABASE_URL: ${DATABASE_URL}
      TA_ELO_MEN_URL: ${TA_ELO_MEN_URL:-}
      TA_ELO_WOMEN_URL: ${TA_ELO_WOMEN_URL:-}
      TA_YELO_MEN_URL: ${TA_YELO_MEN_URL:-}
      TA_YELO_WOMEN_URL: ${TA_YELO_WOMEN_URL:-}
      SCRAPER_USER_AGENT: ${SCRAPER_USER_AGENT:-}
      TA_DRAW_EXAMPLE_URL: ${TA_DRAW_EXAMPLE_URL:-}
    volumes:
      - ./dagster_home:/opt/dagster/dagster_home
      - ./backfills:/opt/dagster/app/backfills:ro
    command: ["dagster-daemon", "run", "-w", "/opt/dagster/dagster_home/workspace.yaml"]

volumes:
  tennis_dagster_pgdata:


